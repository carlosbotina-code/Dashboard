<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Feedback</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; max-width: 800px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 120px; margin: 15px 0; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .feedback-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; }
        .resolved { text-decoration: line-through; color: #95a5a6; }
        .tag-admin { background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .hidden { display: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="card">
    <a href="index.html" style="text-decoration: none; color: #3498db;">‚Üê Back to Menu</a>
    
        <div id="userView" class="hidden">
            <h2>üí° Share your feedback</h2>
            <p>What would you like to improve or what issues have you encountered?</p>
            <textarea id="feedbackText" placeholder="Write your comments here..."></textarea>
            <button onclick="sendFeedback()">Submit Feedback</button>
            <p id="msg" style="color: green;"></p>
        </div>

        <div id="adminView" class="hidden">
            <h2>üìã Received Suggestions <span class="tag-admin">Admin</span></h2>
            <div id="feedbackList">
                <p>Loading comments...</p>
            </div>
        </div>
    </div>


    <script>
        // 1. CONFIGURACI√ìN
            const SUPABASE_URL = 'https://lmgpsbkbfeetdcgjxlbd.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_cWlfcyK-hFgRqKyId7V32A_fp72fDNt';

            // CAMBIO AQU√ç: Renombramos a 'supabaseClient' para evitar el choque con la librer√≠a
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            const ADMIN_EMAIL = 'carlos.botina@innovuslabs.com'; 

            async function init() {
                // CAMBIO AQU√ç: Usamos supabaseClient
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) { 
                    window.location.href = 'portal.html'; 
                    return; 
                }

                if (session.user.email === ADMIN_EMAIL) {
                    document.getElementById('adminView').classList.remove('hidden');
                    loadFeedback();
                } else {
                    document.getElementById('userView').classList.remove('hidden');
                }
            }

            // Funci√≥n para el Usuario
            async function sendFeedback() {
                const text = document.getElementById('feedbackText').value;
                const { data: { session } } = await supabaseClient.auth.getSession();

                if (!text) return alert("Please write something before submitting");

                // CAMBIO AQU√ç: Usamos supabaseClient
                const { error } = await supabaseClient.from('feedback').insert([
                    { user_email: session.user.email, message: text }
                ]);

                if (error) alert("Error: " + error.message);
                else {
                    document.getElementById('feedbackText').value = "";
                    document.getElementById('msg').textContent = "Thank you! Your feedback has been sent."
                }
            }

            // Funci√≥n para el Admin
            async function loadFeedback() {
                // CAMBIO AQU√ç: Usamos supabaseClient
                const { data, error } = await supabaseClient
                    .from('feedback')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) return console.error(error);

                const listCont = document.getElementById('feedbackList');
                listCont.innerHTML = data.length ? '' : 'No comments yet.';

                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'feedback-item';
                    div.innerHTML = `
                        <div>
                            <strong class="${item.is_resolved ? 'resolved' : ''}">${item.message}</strong><br>
                            <small>De: ${item.user_email} - ${new Date(item.created_at).toLocaleDateString()}</small>
                        </div>
                        <input type="checkbox" ${item.is_resolved ? 'checked' : ''} 
                            onclick="toggleResolved('${item.id}', ${item.is_resolved})">
                    `;
                    listCont.appendChild(div);
                });
            }

            async function toggleResolved(id, currentState) {
                // CAMBIO AQU√ç: Usamos supabaseClient
                await supabaseClient.from('feedback').update({ is_resolved: !currentState }).eq('id', id);
                loadFeedback(); 
            }

            init();
    </script>
</body>
</html>